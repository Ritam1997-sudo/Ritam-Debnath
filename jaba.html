<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PhysioScript - Prescription Generation Tool</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        
        .prescription-template {
            background: white;
            border: 1px solid #e5e7eb;
        }
        
        .doctor-header {
            background: linear-gradient(135deg, #a7f3d0 0%, #6ee7b7 50%, #34d399 100%); /* Light green gradient */
            color: #1f2937; /* Dark gray text for contrast */
            position: relative;
            padding: 12px;
        }
        
        .doctor-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Ccircle cx='30' cy='30' r='2'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E") repeat;
        }
        
        .prescription-content {
            font-size: 12px;
            line-height: 1.4;
            padding: 12px;
        }
        
        .patient-info-line {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
        }
        
        .separator-line {
            border-top: 1px solid #d1d5db;
            margin: 8px 0;
        }
        
        .form-input:focus {
            border-color: #34d399;
            box-shadow: 0 0 0 3px rgba(52, 211, 153, 0.1);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #34d399 0%, #15803d 100%); /* Green gradient for buttons */
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(52, 211, 153, 0.3);
        }
        
        .patient-card {
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }
        
        .patient-card:hover {
            border-left-color: #34d399;
            transform: translateX(5px);
        }
        
        .loading {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .medical-icon {
            background: linear-gradient(135deg, #34d399 0%, #15803d 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">
                <i class="fas fa-stethoscope medical-icon mr-3"></i>
                PhysioScript
            </h1>
            <p class="text-gray-600 text-lg">Professional Prescription Management System for Physiotherapists</p>
        </div>

        <!-- Main Navigation -->
        <div class="flex flex-wrap justify-center gap-4 mb-8">
            <button onclick="showSection('newPrescription')" 
                    class="btn-primary text-white px-6 py-3 rounded-lg font-semibold flex items-center gap-2 hover:shadow-lg transition-all">
                <i class="fas fa-prescription-bottle"></i>
                Generate Prescription
            </button>
            <button onclick="showSection('patientHistory')" 
                    class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold flex items-center gap-2 hover:shadow-lg transition-all">
                <i class="fas fa-history"></i>
                Check History
            </button>
        </div>

        <!-- New Prescription Section -->
        <div id="newPrescriptionSection" class="section">
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                    <i class="fas fa-user-plus text-green-600"></i>
                    Patient Information
                </h2>
                
                <form id="patientForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Patient Name *</label>
                        <input type="text" id="patientName" required 
                               class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Age *</label>
                        <input type="number" id="patientAge" required min="1" max="120"
                               class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Gender *</label>
                        <select id="patientGender" required 
                                class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none">
                            <option value="">Select Gender</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Contact Number</label>
                        <input type="tel" id="patientContact" 
                               class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none">
                    </div>
                    
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Address</label>
                        <textarea id="patientAddress" rows="2" 
                                  class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none"></textarea>
                    </div>
                    
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Doctor's Notes</label>
                        <textarea id="doctorNotes" rows="8" 
                                  class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none" 
                                  placeholder="Enter all relevant medical notes, observations, and recommendations"></textarea>
                    </div>
                    <div class="md:col-span-2">
  <button type="submit"
    class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 focus:outline-none">
    Save Patient Data
  </button>
</div>

                </form>
               
                
                <div class="flex flex-wrap gap-4 mt-6">
                    <button onclick="generatePrescription()" 
                            class="btn-primary text-white px-6 py-3 rounded-lg font-semibold flex items-center gap-2">
                        <i class="fas fa-save"></i>
                        Save & Generate Prescription
                    </button>
                    <button onclick="clearForm()" 
                            class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-semibold flex items-center gap-2">
                        <i class="fas fa-eraser"></i>
                        Clear Form
                    </button>
                </div>
            </div>
        </div>

        <!-- Patient History Section -->
        <div id="patientHistorySection" class="section hidden">
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                    <i class="fas fa-search text-green-600"></i>
                    Patient History
                </h2>
                
                <div class="flex flex-wrap gap-4 mb-6">
                    <div class="flex-1 min-w-64">
                        <input type="text" id="searchPatientId" 
                               class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none" 
                               placeholder="Enter Patient ID (e.g., PT-001)">
                    </div>
                    <button onclick="searchPatient()" 
                            class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-semibold flex items-center gap-2">
                        <i class="fas fa-search"></i>
                        Search Patient
                    </button>
                    <button onclick="loadAllPatients()" 
                            class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-semibold flex items-center gap-2">
                        <i class="fas fa-list"></i>
                        Load All Patients
                    </button>
                </div>
                
                <div id="searchResults" class="space-y-4"></div>
            </div>
        </div>

        <!-- Prescription Display Section -->
        <div id="prescriptionSection" class="section hidden">
            <div class="prescription-template max-w-4xl mx-auto" id="prescriptionTemplate">
                <!-- Doctor Header -->
                <div class="doctor-header relative">
                    <div class="text-center relative z-10">
                        <div class="flex items-center justify-center mb-2">
                            <div class="bg-white bg-opacity-20 p-2 rounded-full mr-2">
                                <i class="fas fa-user-md text-xl"></i>
                            </div>
                            <div class="text-left">
                                <h1 class="text-2xl font-bold mb-1">Dr. Sarah Johnson</h1>
                                <p class="text-sm mb-1 opacity-95">Physiotherapist & Rehabilitation Specialist</p>
                                <p class="text-xs opacity-90">DPT, MS in Sports Medicine</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-2 text-xs bg-white bg-opacity-10 rounded-lg p-2">
                            <div class="flex items-center justify-center gap-1">
                                <i class="fas fa-map-marker-alt"></i>
                                <span>123 Health Center, Medical District</span>
                            </div>
                            <div class="flex items-center justify-center gap-1">
                                <i class="fas fa-phone"></i>
                                <span>+1 (555) 123-4567</span>
                            </div>
                            <div class="flex items-center justify-center gap-1">
                                <i class="fas fa-certificate"></i>
                                <span>License: PT-2024-5678</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Prescription Content -->
                <div class="prescription-content">
                    <div class="mb-4">
                        <h3 class="text-sm font-semibold text-gray-800 mb-1">Patient Information</h3>
                        <div class="patient-info-line">
                            <span>Patient ID: <span id="displayPatientId" class="font-mono"></span></span>
                            <span>Name: <span id="displayPatientName"></span></span>
                            <span>Age: <span id="displayPatientAge"></span> years</span>
                            <span>Gender: <span id="displayPatientGender"></span></span>
                            <span>Contact: <span id="displayPatientContact"></span></span>
                            <span>Date: <span id="displayDate"></span></span>
                            <span>Address: <span id="displayPatientAddress"></span></span>
                        </div>
                    </div>

                    <div class="separator-line"></div>

                    <div class="mb-4">
                        <h3 class="text-sm font-semibold text-gray-800 mb-1">Doctor's Notes</h3>
                        <p class="whitespace-pre-line" id="displayDoctorNotes"></p>
                    </div>
                </div>
            </div>

            <div class="flex justify-center gap-4 mt-6 no-print">
                <button onclick="generatePDF()" 
                        class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-semibold flex items-center gap-2 shadow-lg">
                    <i class="fas fa-file-pdf"></i>
                    Download PDF
                </button>
                <button onclick="showSection('newPrescription')" 
                        class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold flex items-center gap-2 shadow-lg">
                    <i class="fas fa-plus"></i>
                    New Prescription
                </button>
                <button onclick="showSection('patientHistory')" 
                        class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-lg font-semibold flex items-center gap-2 shadow-lg">
                    <i class="fas fa-arrow-left"></i>
                    Back to History
                </button>
            </div>
        </div>

        <!-- Edit Patient Modal -->
        <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-lg max-w-4xl w-full max-h-screen overflow-y-auto">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Edit Patient Information</h2>
                        <button onclick="closeEditModal()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    
                    <form id="editPatientForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <input type="hidden" id="editPatientId">
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Patient Name *</label>
                            <input type="text" id="editPatientName" required 
                                   class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Age *</label>
                            <input type="number" id="editPatientAge" required min="1" max="120"
                                   class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Gender *</label>
                            <select id="editPatientGender" required 
                                    class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none">
                                <option value="">Select Gender</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Contact Number</label>
                            <input type="tel" id="editPatientContact" 
                                   class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none">
                        </div>
                        
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Address</label>
                            <textarea id="editPatientAddress" rows="2" 
                                      class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none"></textarea>
                        </div>
                        
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Doctor's Notes</label>
                            <textarea id="editDoctorNotes" rows="8" 
                                      class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none"></textarea>
                        </div>
                    </form>
                    
                    <div class="flex flex-wrap gap-4 mt-6">
                        <button onclick="updatePatient()" 
                                class="btn-primary text-white px-6 py-3 rounded-lg font-semibold flex items-center gap-2">
                            <i class="fas fa-save"></i>
                            Update & Generate Prescription
                        </button>
                        <button onclick="closeEditModal()" 
                                class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-semibold flex items-center gap-2">
                            <i class="fas fa-times"></i>
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading Spinner -->
        <div id="loadingSpinner" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
            <div class="bg-white p-6 rounded-lg text-center shadow-xl">
                <i class="fas fa-spinner fa-spin text-green-600 text-3xl mb-4"></i>
                <p class="text-gray-700">Processing...</p>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        
        // Global variables
        let currentPatientId = '';
        let patientCounter = 1;
        
        
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            showSection('newPrescription');
            loadPatientCounter();
        });
        
        // Section management
        function showSection(sectionName) {
            const sections = document.querySelectorAll('.section');
            sections.forEach(section => section.classList.add('hidden'));
            
            document.getElementById(sectionName + 'Section').classList.remove('hidden');
        }
        
        // Generate unique patient ID
        function generatePatientId() {
            const id = `PT-${String(patientCounter).padStart(3, '0')}`;
            patientCounter++;
            localStorage.setItem('patientCounter', patientCounter);
            return id;
        }
        
        // Load patient counter from localStorage
        function loadPatientCounter() {
            const savedCounter = localStorage.getItem('patientCounter');
            if (savedCounter) {
                patientCounter = parseInt(savedCounter);
            }
        }
        
        // Clear form
        function clearForm() {
            document.getElementById('patientForm').reset();
        }
        
        // Generate prescription
        function generatePrescription() {
            if (!validateForm()) return;
            
            showLoading(true);
            
            const patientData = collectFormData();
            patientData.id = generatePatientId();
            patientData.createdDate = new Date().toISOString().split('T')[0];
            patientData.lastUpdated = new Date().toISOString();
            
            currentPatientId = patientData.id;
            
            // Save to localStorage (fallback)
            saveToLocalStorage(patientData);
            
            // Try to save to Google Sheets
            saveToGoogleSheets(patientData).then(() => {
                displayPrescription(patientData);
                showLoading(false);
                showSection('prescription');
            }).catch(error => {
                console.error('Failed to save to Google Sheets:', error);
                displayPrescription(patientData);
                showLoading(false);
                showSection('prescription');
                showNotification('Data saved locally. Google Sheets integration requires API key setup.', 'warning');
            });
        }
        
        // Validate form
        function validateForm() {
            const required = ['patientName', 'patientAge', 'patientGender'];
            for (let field of required) {
                const element = document.getElementById(field);
                if (!element.value.trim()) {
                    showNotification(`Please fill in ${field.replace('patient', '').replace(/([A-Z])/g, ' $1').toLowerCase()}`, 'error');
                    element.focus();
                    return false;
                }
            }
            return true;
        }
        
        // Collect form data
        function collectFormData() {
            return {
                name: document.getElementById('patientName').value.trim(),
                age: document.getElementById('patientAge').value,
                gender: document.getElementById('patientGender').value,
                contact: document.getElementById('patientContact').value.trim(),
                address: document.getElementById('patientAddress').value.trim(),
                doctorNotes: document.getElementById('doctorNotes').value.trim()
            };
        }
        
        // Display prescription
        function displayPrescription(data) {
            const currentDate = new Date().toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            document.getElementById('displayPatientId').textContent = data.id;
            document.getElementById('displayPatientName').textContent = data.name;
            document.getElementById('displayPatientAge').textContent = data.age;
            document.getElementById('displayPatientGender').textContent = data.gender;
            document.getElementById('displayPatientContact').textContent = data.contact || 'Not provided';
            document.getElementById('displayPatientAddress').textContent = data.address || 'Not provided';
            document.getElementById('displayDate').textContent = currentDate;
            document.getElementById('displayDoctorNotes').textContent = data.doctorNotes || 'None';
        }
        
        // Simplified PDF generation with enhanced structure
        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });

            // Constants
            const pageWidth = 210;
            const pageHeight = 297;
            const margin = 10;
            const contentWidth = pageWidth - 2 * margin;
            let y = margin;

            // Color scheme
            const colors = {
                lightGreen: [167, 243, 208],  // Light green for letterhead
                greenAccent: [52, 211, 153],  // Green accent
                gray: [107, 114, 128],        // Gray-500
                lightGray: [243, 244, 246],   // Gray-100
                darkGray: [75, 85, 99]        // Gray-600
            };

            // Letterhead with light green gradient
            doc.setFillColor(...colors.lightGreen);
            doc.rect(0, 0, pageWidth, 40, 'F');
            
            // Header accent line
            doc.setFillColor(...colors.greenAccent);
            doc.rect(0, 40, pageWidth, 2, 'F');

            // Medical cross icon
            doc.setFillColor(255, 255, 255);
            doc.circle(margin + 10, 20, 8, 'F');
            doc.setFillColor(...colors.greenAccent);
            doc.rect(margin + 8, 15, 4, 10, 'F');
            doc.rect(margin + 6, 18, 8, 4, 'F');

            // Doctor information
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(16);
            doc.setTextColor(...colors.darkGray);
            doc.text('Dr. Sarah Johnson', margin + 25, y + 8);
            
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text('Physiotherapist & Rehabilitation Specialist', margin + 25, y + 12);
            
            doc.setFontSize(8);
            doc.text('DPT, MS in Sports Medicine', margin + 25, y + 16);
            
            // Contact information
            doc.setFillColor(255, 255, 255, 0.2);
            doc.rect(margin + 25, y + 18, contentWidth - 15, 8, 'F');
            
            doc.setFontSize(7);
            doc.text('📍 123 Health Center, Medical District, City 12345', margin + 27, y + 21);
            doc.text('📞 +1 (555) 123-4567  ✉ dr.johnson@healthcenter.com  🏥 License: PT-2024-5678', margin + 27, y + 24);

            y += 45;

            // Patient information (horizontal layout)
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(10);
            doc.setTextColor(...colors.darkGray);
            doc.text('PATIENT INFORMATION', margin, y);

            y += 5;

            const patientData = {
                id: document.getElementById('displayPatientId').textContent,
                name: document.getElementById('displayPatientName').textContent,
                age: document.getElementById('displayPatientAge').textContent,
                gender: document.getElementById('displayPatientGender').textContent,
                contact: document.getElementById('displayPatientContact').textContent,
                address: document.getElementById('displayPatientAddress').textContent,
                date: document.getElementById('displayDate').textContent
            };

            doc.setFont('helvetica', 'normal');
            doc.setFontSize(8);

            // Construct horizontal patient info string
            const patientInfo = `Patient ID: ${patientData.id}  |  Name: ${patientData.name}  |  Age: ${patientData.age} years  |  Gender: ${patientData.gender}  |  Contact: ${patientData.contact}  |  Date: ${patientData.date}  |  Address: ${patientData.address}`;
            const splitPatientInfo = doc.splitTextToSize(patientInfo, contentWidth);
            doc.text(splitPatientInfo, margin, y);
            y += splitPatientInfo.length * 4 + 4;

            // Separation line
            doc.setDrawColor(...colors.gray);
            doc.setLineWidth(0.5);
            doc.line(margin, y, margin + contentWidth, y);
            y += 4;

            // Doctor's notes
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(10);
            doc.text('DOCTOR\'S NOTES', margin, y);
            y += 5;

            doc.setFont('helvetica', 'normal');
            doc.setFontSize(8);
            const doctorNotes = document.getElementById('displayDoctorNotes').textContent || 'None';
            const splitNotes = doc.splitTextToSize(doctorNotes, contentWidth);
            doc.text(splitNotes, margin, y);
            y += splitNotes.length * 4 + 4;

            // Footer with border line
            doc.setDrawColor(...colors.gray);
            doc.setLineWidth(0.5);
            doc.line(margin, pageHeight - 15, margin + contentWidth, pageHeight - 15);

            doc.setFillColor(...colors.lightGray);
            doc.rect(0, pageHeight - 10, pageWidth, 10, 'F');
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(6);
            doc.setTextColor(...colors.gray);
            doc.text('Generated by PhysioScript - Professional Prescription Management System', margin, pageHeight - 4);

            // Save the PDF
            const patientId = document.getElementById('displayPatientId').textContent;
            doc.save(`PhysioScript_Prescription_${patientId}_${new Date().toISOString().split('T')[0]}.pdf`);
        }
        
        // Save to localStorage
        function saveToLocalStorage(data) {
            let patients = JSON.parse(localStorage.getItem('patients')) || [];
            const existingIndex = patients.findIndex(p => p.id === data.id);
            
            if (existingIndex >= 0) {
                patients[existingIndex] = data;
            } else {
                patients.push(data);
            }
            
            localStorage.setItem('patients', JSON.stringify(patients));
        }
        
        // Save to Google Sheets
        async function saveToGoogleSheets(data) {
            return new Promise((resolve, reject) => {
                setTimeout(() => {
                    if (API_KEY === 'YOUR_GOOGLE_SHEETS_API_KEY') {
                        reject(new Error('API key not configured'));
                    } else {
                        resolve();
                    }
                }, 1000);
            });
        }
        
        // Search patient
        function searchPatient() {
            const patientId = document.getElementById('searchPatientId').value.trim();
            if (!patientId) {
                showNotification('Please enter a patient ID', 'warning');
                return;
            }
            
            showLoading(true);
            
            const patients = JSON.parse(localStorage.getItem('patients')) || [];
            const patient = patients.find(p => p.id.toLowerCase() === patientId.toLowerCase());
            
            if (patient) {
                displaySearchResults([patient]);
            } else {
                displaySearchResults([]);
                showNotification('Patient not found', 'error');
            }
            
            showLoading(false);
        }
        
        // Load all patients
        function loadAllPatients() {
            showLoading(true);
            
            const patients = JSON.parse(localStorage.getItem('patients')) || [];
            displaySearchResults(patients);
            
            showLoading(false);
        }
        
        // Display search results
        function displaySearchResults(patients) {
            const resultsContainer = document.getElementById('searchResults');
            
            if (patients.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-user-slash text-4xl mb-4"></i>
                        <p>No patients found</p>
                    </div>
                `;
                return;
            }
            
            resultsContainer.innerHTML = patients.map(patient => `
                <div class="patient-card bg-gray-50 p-4 rounded-lg border">
                    <div class="flex flex-wrap justify-between items-start gap-4">
                        <div class="flex-1 min-w-64">
                            <h3 class="font-semibold text-lg text-gray-800">${patient.name}</h3>
                            <p class="text-gray-600">ID: ${patient.id} | Age: ${patient.age} | Gender: ${patient.gender}</p>
                            <p class="text-gray-600">Contact: ${patient.contact || 'Not provided'}</p>
                            <p class="text-sm text-gray-500">Created: ${patient.createdDate || 'Unknown'}</p>
                            <p class="text-sm text-gray-700 mt-2"><strong>Notes:</strong> ${patient.doctorNotes ? patient.doctorNotes.substring(0, 100) + '...' : 'None'}</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="editPatient('${patient.id}')" 
                                    class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm flex items-center gap-1">
                                <i class="fas fa-edit"></i>
                                Edit
                            </button>
                            <button onclick="viewPrescription('${patient.id}')" 
                                    class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm flex items-center gap-1">
                                <i class="fas fa-eye"></i>
                                View
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Edit patient
        function editPatient(patientId) {
            const patients = JSON.parse(localStorage.getItem('patients')) || [];
            const patient = patients.find(p => p.id === patientId);
            
            if (!patient) {
                showNotification('Patient not found', 'error');
                return;
            }
            
            document.getElementById('editPatientId').value = patient.id;
            document.getElementById('editPatientName').value = patient.name;
            document.getElementById('editPatientAge').value = patient.age;
            document.getElementById('editPatientGender').value = patient.gender;
            document.getElementById('editPatientContact').value = patient.contact || '';
            document.getElementById('editPatientAddress').value = patient.address || '';
            document.getElementById('editDoctorNotes').value = patient.doctorNotes || '';
            
            document.getElementById('editModal').classList.remove('hidden');
        }
        
        // Close edit modal
        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
        }
        
        // Update patient
        function updatePatient() {
            if (!validateEditForm()) return;
            
            showLoading(true);
            
            const patientData = {
                id: document.getElementById('editPatientId').value,
                name: document.getElementById('editPatientName').value.trim(),
                age: document.getElementById('editPatientAge').value,
                gender: document.getElementById('editPatientGender').value,
                contact: document.getElementById('editPatientContact').value.trim(),
                address: document.getElementById('editPatientAddress').value.trim(),
                doctorNotes: document.getElementById('editDoctorNotes').value.trim(),
                lastUpdated: new Date().toISOString()
            };
            
            const patients = JSON.parse(localStorage.getItem('patients')) || [];
            const originalPatient = patients.find(p => p.id === patientData.id);
            if (originalPatient) {
                patientData.createdDate = originalPatient.createdDate;
            }
            
            currentPatientId = patientData.id;
            
            saveToLocalStorage(patientData);
            
            closeEditModal();
            displayPrescription(patientData);
            showLoading(false);
            showSection('prescription');
            showNotification('Patient information updated successfully', 'success');
        }
        
        // Validate edit form
        function validateEditForm() {
            const required = ['editPatientName', 'editPatientAge', 'editPatientGender'];
            for (let field of required) {
                const element = document.getElementById(field);
                if (!element.value.trim()) {
                    showNotification(`Please fill in ${field.replace('edit', '').replace('patient', '').replace(/([A-Z])/g, ' $1').toLowerCase()}`, 'error');
                    element.focus();
                    return false;
                }
            }
            return true;
        }
        
        // View prescription
        function viewPrescription(patientId) {
            const patients = JSON.parse(localStorage.getItem('patients')) || [];
            const patient = patients.find(p => p.id === patientId);
            
            if (patient) {
                currentPatientId = patientId;
                displayPrescription(patient);
                showSection('prescription');
            } else {
                showNotification('Patient not found', 'error');
            }
        }
        
        // Show/hide loading spinner
        function showLoading(show) {
            const spinner = document.getElementById('loadingSpinner');
            if (show) {
                spinner.classList.remove('hidden');
            } else {
                spinner.classList.add('hidden');
            }
        }
        
        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg text-white font-medium shadow-lg ${
                type === 'success' ? 'bg-green-600' :
                type === 'error' ? 'bg-red-600' :
                type === 'warning' ? 'bg-yellow-600' :
                'bg-green-600'
            }`;
            notification.innerHTML = `
                <div class="flex items-center gap-2">
                    <i class="fas ${
                        type === 'success' ? 'fa-check-circle' :
                        type === 'error' ? 'fa-exclamation-circle' :
                        type === 'warning' ? 'fa-exclamation-triangle' :
                        'fa-info-circle'
                    }"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        
        // Close modal on outside click
        document.getElementById('editModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeEditModal();
            }
        });
        
        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeEditModal();
            }
        });
        
    </script>
</body>
</html>
